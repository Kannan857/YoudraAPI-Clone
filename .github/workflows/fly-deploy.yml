name: Deploy to Fly.io

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_APP_NAME: ${{ vars.FLY_APP_NAME || 'youdraapi-clone' }}
      # Non-secret config (use repo variables)
      POSTGRES_SERVER: ${{ vars.POSTGRES_SERVER }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      POSTGRES_PORT: ${{ vars.POSTGRES_PORT || '15580' }}
      QDRANT_URL: ${{ vars.QDRANT_URL }}
      QDRANT_ACTIVITY_COLLECTION_NAME: ${{ vars.QDRANT_ACTIVITY_COLLECTION_NAME }}
      QDRANT_GOAL_BUILDER_COLLECTION_NAME: ${{ vars.QDRANT_GOAL_BUILDER_COLLECTION_NAME }}
      API_V1_PREFIX: ${{ vars.API_V1_PREFIX || '/api/v1' }}
      PROJECT_NAME: ${{ vars.PROJECT_NAME || 'My FastAPI Application' }}
      SECRET_MANAGER_ENABLED: ${{ vars.SECRET_MANAGER_ENABLED || 'false' }}
      GOOGLE_CLIENT_ID: ${{ vars.GOOGLE_CLIENT_ID }}
      LLM_FLAG: ${{ vars.LLM_FLAG || 'gemini' }}
      RABBITMQ_QUEUE: ${{ vars.RABBITMQ_QUEUE }}
      RABBITMQ_HOST: ${{ vars.RABBITMQ_HOST }}
      RABBITMQ_PORT: ${{ vars.RABBITMQ_PORT || '5671' }}
      RABBITMQ_VHOST: ${{ vars.RABBITMQ_VHOST }}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ vars.ACCESS_TOKEN_EXPIRE_MINUTES || '600' }}
      # Secrets (use repo secrets)
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      OPEN_AI_API_KEY: ${{ secrets.OPEN_AI_API_KEY }}
      OPEN_AI_APIKEY: ${{ secrets.OPEN_AI_APIKEY }}
      QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
      SERP_API_KEY: ${{ secrets.SERP_API_KEY }}
      GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
      RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
      RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      STRIPE_CUSTOM_SEAT_PRICE_ID: ${{ secrets.STRIPE_CUSTOM_SEAT_PRICE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set Fly secrets
        run: |
          set -euo pipefail
          : "${FLY_APP_NAME:=youdraapi-clone}"

          required=(
            POSTGRES_SERVER POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB POSTGRES_PORT
            SECRET_KEY ACCESS_TOKEN_EXPIRE_MINUTES
            OPEN_AI_API_KEY QDRANT_URL QDRANT_API_KEY
            RABBITMQ_QUEUE RABBITMQ_USER RABBITMQ_PASSWORD RABBITMQ_HOST RABBITMQ_PORT RABBITMQ_VHOST
            SENDGRID_API_KEY
          )

          missing=()
          for key in "${required[@]}"; do
            if [ -z "${!key:-}" ]; then
              missing+=("$key")
            fi
          done

          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

          cat <<EOF | flyctl secrets import --app "$FLY_APP_NAME" --stage
POSTGRES_SERVER=${POSTGRES_SERVER}
POSTGRES_USER=${POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
POSTGRES_DB=${POSTGRES_DB}
POSTGRES_PORT=${POSTGRES_PORT}
SECRET_KEY=${SECRET_KEY}
ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
OPEN_AI_API_KEY=${OPEN_AI_API_KEY}
OPEN_AI_APIKEY=${OPEN_AI_APIKEY}
QDRANT_URL=${QDRANT_URL}
QDRANT_API_KEY=${QDRANT_API_KEY}
QDRANT_ACTIVITY_COLLECTION_NAME=${QDRANT_ACTIVITY_COLLECTION_NAME}
QDRANT_GOAL_BUILDER_COLLECTION_NAME=${QDRANT_GOAL_BUILDER_COLLECTION_NAME}
API_V1_PREFIX=${API_V1_PREFIX}
PROJECT_NAME=${PROJECT_NAME}
SECRET_MANAGER_ENABLED=${SECRET_MANAGER_ENABLED}
GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}
GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
LLM_FLAG=${LLM_FLAG}
RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
RABBITMQ_USER=${RABBITMQ_USER}
RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
RABBITMQ_HOST=${RABBITMQ_HOST}
RABBITMQ_PORT=${RABBITMQ_PORT}
RABBITMQ_VHOST=${RABBITMQ_VHOST}
SENDGRID_API_KEY=${SENDGRID_API_KEY}
SERP_API_KEY=${SERP_API_KEY}
STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
STRIPE_CUSTOM_SEAT_PRICE_ID=${STRIPE_CUSTOM_SEAT_PRICE_ID}
EOF

      - name: Deploy
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "Missing Fly API token (set repo secret FLY_API_TOKEN)"; exit 1; 
          fi
          echo "Deploying app: ${FLY_APP_NAME}"
          flyctl deploy --remote-only --app "$FLY_APP_NAME"
